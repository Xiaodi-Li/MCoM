#!/usr/bin/python
#Virus Total Report fetching:Malware samples

#Written by: Ajit kumar, urwithajit9@gmail.com ,25Feb2015
#No license required for any kind of reuse
#If using this script for your work, please refer this on your willingness


#This script will take a csv file with MD5 hash as input 
#and it will read all MD5 and will fetch the VirusTotal report
#on each MD5 and after receiveing and parsing the report
# will write them to a CSV file path/report.csv

# The CSV file header will have fields as
#["MD5hash","Total","Positive","TrendMicro","F-Secure","McAfee","Symantec","Avast","Kaspersky","BitDefender","Sophos","GData","Panda","Qihoo-360","Scan-Date"]


#input: path for csv file with one column have MD5 hash prfer header name as "MD5hash"

#output: csv file with VirusTotal report with header such as Total,Positive and 10 AV result
        
#Note: You need to register to VirusTotal and get API Key to use this script. Give your key

#value to mykey= ""
#Change in_file_path and out_file_path variable 

#Check for imported module before executating

import simplejson
import urllib
import urllib2
import csv
import time

url = "https://www.virustotal.com/vtapi/v2/file/report"
mykey="Your Virus Total API key"

def get_md5_hash_from_file(file_obj):
    """
    Read a CSV file using csv.DictReader
    """
    result = []
    reader = csv.DictReader(file_obj, delimiter=',')
    for line in reader:
       result.append(line["MD5hash"])
    return result


#Change in_file_path and out_file_path variable 
    
in_file_path = "/home/user/ClaMP/Malware.csv"
out_file_path= "/home/user/ClaMP/VT_report_mal.csv"

#Opening and reading all files MD5 Hashes to md5hashes

fileobj= open(in_file_path,"r")
md5hashes= get_md5_hash_from_file(fileobj)
fileobj.close()


#open output csv to write the result

out_csv_file =open(out_file_path,"wa")
writer = csv.writer(out_csv_file, delimiter=',')

#Writing header

writer.writerow(["MD5hash","Total","Positive","TrendMicro","F-Secure","McAfee","Symantec","Avast","Kaspersky","BitDefender","Sophos","GData","Panda","Qihoo-360","Scan-Date"])

#Some time VirusTotal request break and count help to track and start the fetching

count = 0

for mymd5 in md5hashes:
    parameters ={"resource":mymd5,"apikey":mykey}
    data = urllib.urlencode(parameters)
    req = urllib2.Request(url, data)
    response = urllib2.urlopen(req)
    json= response.read()    
    result_json = simplejson.loads(json)    
    total=result_json.get("total")
    positives= result_json.get("positives")
    trendMacro = result_json.get("scans", {}).get("TrendMicro", {}).get("result")
    f_secure= result_json.get("scans", {}).get("F-Secure", {}).get("result")
    McAfee = result_json.get("scans", {}).get("McAfee", {}).get("result")
    Symantec= result_json.get("scans", {}).get("Symantec", {}).get("result")
    Avast=result_json.get("scans", {}).get("Avast", {}).get("result")
    Kaspersky=result_json.get("scans", {}).get("Kaspersky", {}).get("result")
    BitDefender=result_json.get("scans", {}).get("BitDefender", {}).get("result")
    Sophos=result_json.get("scans", {}).get("Sophos", {}).get("result")
    GData=result_json.get("scans", {}).get("GData", {}).get("result")
    Panda=result_json.get("scans", {}).get("Panda", {}).get("result")
    Qihoo_360=result_json.get("scans", {}).get("Qihoo-360", {}).get("result")
    scan_date = result_json.get("scan_date")
    writer.writerow([mymd5,total,positives,trendMacro,f_secure,McAfee,Symantec,Avast,Kaspersky,BitDefender,Sophos,GData,Panda,Qihoo_360,scan_date])
    time.sleep(18)
    print "Virus Total report Fetch and written for file:",count
    count=count+1

out_csv_file.close()




